#!/usr/bin/env -S bash -e

# -------------------------------------------------------------------------------------------------------------------- #
# INITIALIZATION.
# -------------------------------------------------------------------------------------------------------------------- #

init() {
  # Apps.
  apt=$( command -v apt )
  awk=$( command -v awk )
  curl=$( command -v curl )
  mv=$( command -v mv )
  sed=$( command -v sed )
  shutdown=$( command -v shutdown )
  systemctl=$( command -v systemctl )

  # Run.
  networkd && resolved && reboot
}

# -------------------------------------------------------------------------------------------------------------------- #
# SYSTEMD / NETWORKD.
# -------------------------------------------------------------------------------------------------------------------- #

networkd() {
  local d='/etc/systemd/network'; [[ ! -d "${d}" ]] && exit 1
  local eth; mapfile -t eth < <( ip -br l | ${awk} '$1 !~ "lo|vir|wl" { print $1 }' )

  for i in "${eth[@]}"; do
    ${curl} -fsSLo "${d}/${i}.network" 'https://uaik.github.io/conf/systemd/dhcp.network' \
      && ${sed} -i -e "s|Name=|Name=${i}|g" "${d}/${i}.network"
  done

  ${systemctl} enable systemd-networkd
  [[ -f '/etc/network/interfaces' ]] && { ${mv} '/etc/network/interfaces' '/etc/network/interfaces.disable'; }
}

# -------------------------------------------------------------------------------------------------------------------- #
# SYSTEMD / RESOLVED.
# -------------------------------------------------------------------------------------------------------------------- #

resolved() {
  ${apt} install --yes systemd-resolved
}

# -------------------------------------------------------------------------------------------------------------------- #
# REBOOT.
# -------------------------------------------------------------------------------------------------------------------- #

reboot() {
  ${shutdown} -r now
}

# -------------------------------------------------------------------------------------------------------------------- #
# -------------------------------------------------< RUNNING SCRIPT >------------------------------------------------- #
# -------------------------------------------------------------------------------------------------------------------- #

init "$@"; exit 0
